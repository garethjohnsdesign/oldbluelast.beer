{% extends 'merch/_layouts/main' %}

{% set products = craft.products.all() %}

{% block main %}

    <div class="grid-container">
        <div class="grid-x">

    {% for product in products %}
            <div class="small-12 medium-6 cell">
              
          {% for image in product.image.all() %}
          <div class="image--square" data-interchange="{% include "_includes/images/full/1-1/interchange-img-small-12-medium-6" %}">
            <div class="grid-y height-100 align-center content">
              <div class="shrink cell text-center padding-2">
 
              </div>
            </div>
          </div>
          {% endfor %}

          <h3>{% if product.url %}{{ product.link }}{% else %}{{ product.title }}{% endif %}</h3>
          {% if product.getVariants()|length %}
                    <form method="POST" class="add-to-cart-form">
                        <input type="hidden" name="action" value="commerce/cart/update-cart">
                        <input type="hidden" name="cartUpdatedNotice" value="Added {{ product.title}} to the cart.">
                        {{ redirectInput('merch/cart') }}
                        <input type="hidden" name="qty" value="1">
                        {{ csrfInput() }}

                        <select name="purchasableId" class="purchasableId text-uppercase">
                          {%- for purchasable in product.getVariants() -%}
                              <option {% if not purchasable.isAvailable %}disabled {% endif %}
                                      data-info="product-{{ product.id }}-purchasable-{{ purchasable.id }}"
                                      value="{{ purchasable.id }}">
                                      {{ purchasable.size }} {{ purchasable.salePrice|commerceCurrency(cart.currency) }}
                              </option>
                          {%- endfor -%}
                        </select>
                        {% if product.hasUnlimitedStock or (product.hasUnlimitedStock == false and product.totalStock > 0 ) %}
                            <button type="submit" class="button large text-uppercase">{{ "Add to cart"|t }}</button>
                        {% else %}
                            {{ "Out of Stock"|t }}
                        {% endif %}
                    </form>

                    {%- for purchasable in product.getVariants() -%}
                        <div id="product-{{ product.id }}-purchasable-{{ purchasable.id }}" class="purchasableInfo" style="display:none;">
                            <strong>Regular Price: </strong><strike>{{ purchasable.price|commerceCurrency(cart.currency) }}</strike><br>
                            <strong>Now: </strong>{{ purchasable.salePrice|commerceCurrency(cart.currency) }}<br>
                            {% if purchasable.sales %}<strong>Sales Applied:</strong><br>{% endif %}
                            <ul>
                                {% for sale in purchasable.sales  %}
                                <li><strong>{{ sale.name }}</strong> {{ sale.description }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    {%- endfor -%}

                {% endif %}

            </div>

    {% endfor %}

        </div>
    </div>



    {% js %}
        $( ".purchasableId" ).change(function(e) {
            $(".purchasableInfo").hide();
            $("#"+($(this).find(":selected").data('info'))).toggle();
        });

        {#
        $('form.add-to-cart-form').submit(function(e){
            e.preventDefault();
            var purchasable = $(this).find('.purchasableId').val();
            $.ajax({
                type: "POST",
                dataType: 'json',
                headers: {
                    "X-CSRF-Token" : '{{ craft.app.request.csrfToken }}',
                },
                url: '',
                data: {
                    'action' : 'commerce/cart/update-cart',
                    'purchasableId': purchasable,
                    'note' : 'from ajax'
                },
                success: function(data){
                    console.log(data);
                }
            });
        });
        #}
    {% endjs %}

{% endblock %}
